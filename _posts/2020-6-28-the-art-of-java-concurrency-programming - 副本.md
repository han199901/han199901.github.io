---
layout: post
title: Java并发编程的艺术读后总结（二）
date: 2020-06-28
categories: 技术
tags: 并发编程
---

## Java 并发机制的底层实现原理

Java 代码在编译后会变成 Java 字节码，字节码被类加载器加载到 JVM 里，JVM 执行字节码，最终需要转化为汇编指令在 CPU 上运行， Java 中所使用的并发机制依赖于 JVM 的实现和 CPU 的指令。

### volatile 的应用

volatile 是轻量级的 synchronized，它在多处理器开发中保证了共享变量的”可见性“。

Java 语言规范的第 3 版中对 volatile 的定义：

>  Java 编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致地更新，线程应该确保通过排他锁单独获得这个变量。

volatile变量在进行写操作时转化成汇编语言会多出一行 **lock 前缀的指令**，这个指令会引起两个步骤

1. **将当前CPU 缓存行（缓存的最小操作单位）的数据写回系统内存**。为了提高处理速度，CPU不直接和内存通信，而是先将系统内存的数据读到内部缓存后再进行操作，操作完后也不知道什么时候写回内存。但现在，**JVM会向CPU发送一条lock前缀的指令，将这个变量所在的缓存行写回到系统内存中**。
2. **这个写回内存的操作会使其他CPU里缓存了当前内存地址的数据无效**。为了保证各个处理器的缓存是一致的，就是实现缓存一致性协议，每个处理器通过嗅探总线上传播的数据来检查自己缓存的值是不是过期了，**当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置为无效状态，当处理器对这个数据进行修改操作时，会重新从系统内存中把数据读到处理器缓存里。**

### synchronized 的实现原理与应用

Java 中的每一个对象都可以作为锁。具体表现形式：

- 对于普通的同步方法，锁是当前实例对象。
- 对于静态同步方法，锁是当前类 Class 对象。
- 对于同步方法快，所示 Synchronized 括号里配置的对象。

